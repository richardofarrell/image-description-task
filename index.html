<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Image Description Task</title>
<style>
  :root{
    --max-width: 1200px;     /* was 900px, card can be larger */
    --accent: #2563eb;       /* primary */
    --accent-weak: #93c5fd;  /* light accent */
    --muted:#6b7280;         /* secondary text */
    --bg:#ffffff;
    --card:#ffffff;
    --shadow: 0 12px 36px rgba(0,0,0,.10); /* deeper shadow */
    --radius: 16px;
  }

  /* Reset + base */
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  html, body { margin:0; padding:0; background:var(--bg); color:#111; font:17px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

  /* Page centering scaffold */
  .page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 32px 20px; /* more breathing room */
  }
  .card {
    width: min(var(--max-width), 96vw); /* fill more width */
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 36px; /* bigger card */
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 20px;
  }

  h1, h2 { margin: 0; line-height:1.2; }
  .help { color: var(--muted); font-size:15px; }

  /* Inputs */
  .field { width: 100%; max-width: 820px; text-align: left; }
  .field > label { display:block; margin: 0 0 6px; font-weight:600; }
  input[type="text"], input[type="number"], select, textarea {
    width:100%; font:inherit; padding:14px 16px; border-radius:14px; border:1px solid #d1d5db;
    background:#fff; font-size: 17px;
  }
  textarea { resize: vertical; min-height: 140px; }

  /* Buttons */
  .row { display:flex; gap:14px; flex-wrap:wrap; justify-content:center; }
  button {
    appearance: none; border:0; background: var(--accent); color:#fff;
    padding:14px 22px; border-radius:14px; font-weight:700; cursor:pointer; font-size:18px;
  }
  button.secondary { background:#e5e7eb; color:#111; }
  button:disabled { opacity:.45; cursor:not-allowed; }

  /* Stimulus layout */
  .stim-stage {
    min-height: 70vh; /* taller stimulus stage */
    display:flex; align-items:center; justify-content:center;
    width: 100%;
  }
  .fixation { font-size: 96px; letter-spacing: 2px; line-height: 1; }
  .stim-img {
    max-width: 94vw; max-height: 72vh;
    object-fit: contain; display:block; border-radius: 12px;
    box-shadow: var(--shadow);
  }

  /* Word counter */
  .counter { font-size: 15px; color: var(--muted); }
  .counter.warning { color:#b45309; }

  /* Slider wrapper */
  .slider-wrap {
    width: 100%;
    max-width: 900px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin: 20px 0; 
  }
  
  /* Slider row and rail */
  .slider-row {
    width: 100%;
    display: flex;
    justify-content: center;
  }
  
  /* Base range element */
  input[type="range"] {
    -webkit-appearance: none; /* reset Safari/Chrome */
    appearance: none;
    width: 100%;
    background: transparent;
    margin: 0 10px;
    height: 18px; /* matches track height for easier vertical centering */
    outline: none;
  }
  
  /* Track */
  input[type="range"]::-webkit-slider-runnable-track {
    height: 18px;
    border-radius: 999px;
    background: linear-gradient(90deg, var(--accent), var(--accent-weak));
  }
  input[type="range"]::-moz-range-track {
    height: 18px;
    border-radius: 999px;
    background: linear-gradient(90deg, var(--accent), var(--accent-weak));
  }
  
  /* Thumb — size + perfect vertical centering on 18px track */
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #fff;
    border: 4px solid var(--accent);
    margin-top: -9px;        /* (thumb 36 - track 18)/2 = 9 -> negative to center */
    box-shadow: var(--shadow);
    cursor: pointer;
  }
  input[type="range"]::-moz-range-thumb {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #fff;
    border: 4px solid var(--accent);
    box-shadow: var(--shadow);
    cursor: pointer;
  }
  
  /* Precise label overlay aligned to slider width */
  .tick-labels {
    position: relative;
    width: 100%;
    height: 2.6em;      /* room for 2 lines */
    margin-top: 10px;
    padding: 0 10px;    /* match input[type=range] horizontal margin */
    overflow: visible;
  }
  
  .tick-label {
    position: absolute;
    top: 0;
    transform: translateX(-50%);
    text-align: center;
    font-size: 16px;
    line-height: 1.2;
    color: #555;
    white-space: normal;       /* allow wrapping */
    word-break: normal;        /* don't break every letter */
    max-width: 20ch;           /* a bit wider so it doesn't turn into a column */
    pointer-events: none;
  }
  
  /* Endpoint alignment */
  .tick-label.start {
    left: 0%;
    transform: none;           /* no centering */
    text-align: left;
  }
  .tick-label.end {
    left: 100%;
    transform: translateX(-100%);
    text-align: right;
  }
  

  /* Monospace helper */
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
</style>
</head>
<body>
<div id="app" class="page"><div class="card">Loading…</div></div>

<script>
/* ================= CONFIG ================= */
const IMAGES = [ "images/000000045596.jpg", "images/000000162092.jpg", "images/000000263425.jpg", "images/000000546823.jpg", "images/000000502336.jpg",
               "images/000000279278.jpg", "images/000000488592.jpg", "images/000000538236.jpg", "images/000000323263.jpg", "images/000000427338.jpg"];
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxeKp2eL4rQobST2jPsk4_djVbL4R8qOlyia5gYkYfFv2A_JnxvV8Igk0cNOj95u18-/exec';
const PROLIFIC = {
  COMPLETION_URL: 'https://app.prolific.com/submissions/complete?cc=YOUR_COMPLETION_CODE'
};

// --- detect Prolific or generate stand-in IDs ---
function getRecruitInfo() {
  const q = Object.fromEntries(new URLSearchParams(location.search));
  if (q.PROLIFIC_PID) {
    return {
      source: 'prolific',
      PROLIFIC_PID: q.PROLIFIC_PID || '',
      STUDY_ID: q.STUDY_ID || '',
      SESSION_ID: q.SESSION_ID || ''
    };
  }
  const gen = (p)=> `${p}-${new Date().toISOString().replace(/[-:.TZ]/g,'')}-${Math.random().toString(36).slice(2,8)}`;
  return {
    source: 'direct',
    PROLIFIC_PID: gen('NP'),
    STUDY_ID: 'NON_PROLIFIC',
    SESSION_ID: gen('SESSION')
  };
}
const Recruit = getRecruitInfo();

// Fire-and-forget POST via hidden form + iframe (no CORS, no preflight in any browser)
function submitToServer(rows) {
  return new Promise((resolve) => {
    const meta = (typeof Recruit !== 'undefined') ? Recruit : { source: 'direct' };
    const payload = JSON.stringify({ meta, rows });

    // ensure a hidden iframe exists
    let iframe = document.getElementById('gsink');
    if (!iframe) {
      iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.name = 'gsink';
      iframe.id = 'gsink';
      document.body.appendChild(iframe);
    }

    // build a hidden form
    const form = document.createElement('form');
    form.action = BACKEND_URL;            // your /exec URL
    form.method = 'POST';
    form.enctype = 'multipart/form-data';
    form.target = 'gsink';                // submit into hidden iframe
    form.style.display = 'none';

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'payload';               // Apps Script reads e.parameter.payload
    input.value = payload;

    form.appendChild(input);
    document.body.appendChild(form);

    // submit and clean up
    form.submit();
    setTimeout(() => { form.remove(); resolve(true); }, 250);
  });
}

/* =============== CONSTANTS =============== */
const N_TRIALS = 10;
const FIXATION_MS = 500;
const ISI_MS = 500;
const IMAGE_MS = 2500;
const WORD_LIMIT = 20;

/* =============== STATE =============== */
const S = {
  pid: "", age: "", gender: "",
  trial: 0,
  order: [],
  data: [],
  picked: []
};

/* =============== UTILS =============== */
const el = id => document.getElementById(id);
const app = el('app');

function view(html){ app.innerHTML = `<div class="page"><div class="card">${html}</div></div>`; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
function pick(images, n){ const arr = images.slice(); shuffle(arr); return arr.slice(0,n); }
function tok(text){
  const P=/[.,!?;:()"'\[\]{}\/\\\-]+/g;
  return (text||"").trim().split(/\s+/).filter(t=>t.replace(P,"").trim().length>0);
}
// Cap only when exceeding limit (don’t strip spaces during typing)
function capIfOver(text, lim){
  const P=/[.,!?;:()"'\[\]{}\/\\\-]+/g;
  const toks=(text||"").trim().split(/\s+/);
  let c=0; for(const t of toks){ if(t.replace(P,"").trim().length>0) c++; }
  if(c<=lim) return text;
  const out=[]; c=0;
  for(const t of toks){
    const add = t.replace(P,"").trim().length>0;
    if(add && c+1>lim) break;
    out.push(t); if(add) c++;
  }
  return out.join(" ");
}
function dlCSV(name, rows){
  if(!rows.length) return alert("No data to download.");
  const heads = Object.keys(rows[0]);
  const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
  const csv = [heads.join(","), ...rows.map(r=>heads.map(h=>esc(r[h])).join(","))].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}), url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}

/* =============== SCREENS =============== */
function start(){
  view(`
    <h1>Welcome</h1>
    <div class="field">
      <label class="mono">Participant ID</label>
      <input id="pid" type="text" placeholder="e.g., P001" autofocus />
    </div>
    <div class="help">Using preloaded images from the script.</div>
    <div class="row">
      <button id="next" disabled>Next</button>
    </div>
  `);

  const pid = el('pid'), next = el('next');
  if (!pid.value && Recruit.PROLIFIC_PID) pid.value = Recruit.PROLIFIC_PID;
  const validate = ()=> next.disabled = pid.value.trim().length===0;
  pid.addEventListener('input', validate); validate();
  next.addEventListener('click', ()=>{ 
    S.pid = pid.value.trim(); 
    demographics(); 
  });
}

function demographics(){
  view(`
    <h2>About You</h2>
    <div class="field">
      <label>Age</label>
      <input id="age" type="number" min="16" max="120" placeholder="e.g., 28" />
    </div>
    <div class="field">
      <label>Gender</label>
      <select id="gender">
        <option value="" selected disabled>Choose…</option>
        <option>Female</option><option>Male</option><option>Non-binary</option>
        <option>Prefer not to say</option><option>Self-describe</option>
      </select>
    </div>
    <div class="row">
      <button class="secondary" id="back">Back</button>
      <button id="cont" disabled>Continue</button>
    </div>
  `);
  const age=el('age'), gender=el('gender'), cont=el('cont'), back=el('back');
  const val = ()=> cont.disabled = !(age.value && gender.value);
  age.addEventListener('input', val); gender.addEventListener('change', val);
  back.addEventListener('click', start);
  cont.addEventListener('click', ()=>{ S.age=age.value; S.gender=gender.value; instructions(); });
}

function instructions(){
  view(`
    <h1>Task Instructions</h1>
    <p>In this task, you will be presented with images. Immediately after you see an image, you will then be asked to describe it, and answer some follow-up questions.</p>
    <p>Your descriptions should aim to capture as much of the image as possible within a maximum of <strong>20 words</strong>.</p>
    <p>You should avoid referring to things you do not see in the image, or using subjective evaluations like ‘I think’, ‘I saw’, ‘probably’, ‘maybe’, etc., and you should avoid starting your descriptions with phrases like ‘an image of’. Simply describe what you see as best you can.</p>
    <div class="row"><button id="begin">Begin</button></div>
  `);
  el('begin').addEventListener('click', startTask);
}

/* Trial flow */
function fixation(){
  view(`<div class="stim-stage"><div class="fixation">+</div></div>`);
  setTimeout(()=> isi(), FIXATION_MS);
}
function isi(){ view(`<div class="stim-stage"></div>`); setTimeout(()=> showImage(), ISI_MS); }
function showImage(){
  const src = S.order[S.trial];
  view(`
    <div class="stim-stage">
      <img class="stim-img" id="stim" src="${src}" alt="stimulus">
    </div>
  `);
  el('stim').addEventListener('error', ()=>{
    document.querySelector('.stim-stage').innerHTML =
      `<div class="help">Could not load image:<br><span class="mono">${src}</span></div>`;
  });
  setTimeout(()=> describe(src), IMAGE_MS);
}
function describe(src){
  view(`
    <h2>Describe the image you just saw in 20 words or fewer</h2>
    <div class="field" style="text-align:center; max-width:680px;">
      <textarea id="desc" rows="4" placeholder="Type here…" autofocus></textarea>
      <div id="counter" class="counter">0 / ${WORD_LIMIT} words</div>
    </div>
    <div class="row"><button id="submit" disabled>Submit</button></div>
  `);
  const ta=el('desc'), counter=el('counter'), btn=el('submit');
  function update(){
    const capped = capIfOver(ta.value, WORD_LIMIT);
    if (capped !== ta.value){
      const atEnd = ta.selectionStart===ta.value.length && ta.selectionEnd===ta.value.length;
      ta.value = capped; if (atEnd) try{ ta.setSelectionRange(ta.value.length, ta.value.length);}catch{}
    }
    const n = tok(ta.value).length;
    counter.textContent = `${n} / ${WORD_LIMIT} words`;
    counter.classList.toggle('warning', n===WORD_LIMIT);
    btn.disabled = (n===0 || n>WORD_LIMIT);
  }
  ta.addEventListener('input', update);
  ta.addEventListener('paste', ()=> setTimeout(update,0));
  ta.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); if(!btn.disabled) btn.click(); }
  });
  update();

  btn.addEventListener('click', ()=>{
    S.data.push({
      pid:S.pid, age:S.age, gender:S.gender,
      trial:S.trial+1, image:src, description: ta.value.trim()
    });
    likert_words();
  });
}

/* Slider component (1–5) */
function sliderBlock({ id, labels, initial = 3 }) {
  // labels: array of 5 strings. Use 'word1|word2' for line breaks.
  const positions = [0, 25, 50, 75, 100];
  const labelHTML = labels.map((text, i) => {
    const html = String(text).replace(/\|/g, '<br>');
    const cls =
      i === 0 ? 'tick-label start' :
      i === 4 ? 'tick-label end'   :
                'tick-label';
    return `<span class="${cls}" style="left:${positions[i]}%">${html}</span>`;
  }).join('');

  return `
    <div class="slider-wrap">
      <div class="slider-row">
        <input id="${id}" type="range" min="1" max="5" step="1" value="${initial}" />
      </div>
      <div class="tick-labels">
        ${labelHTML}
      </div>
    </div>
  `;
}

function likert_words(){
  view(`
    <h2>How many more words would you need to describe everything you saw in the image?</h2>
    ${sliderBlock({
      id: 'lk1',
      labels: ['None', 'A few more', 'Quite a few more', 'Many more', 'A lot more'],
      initial: 3
    })
    }
    <div class="row"><button id="next">Next</button></div>
  `);
  const slider = el('lk1');
  el('next').addEventListener('click', ()=>{
    Object.assign(S.data[S.data.length-1], { need_more_words_1to5: slider.value });
    likert_describable();
  });
}

function likert_describable(){
  view(`
    <h2>To what extent was what you saw in the image difficult or impossible to describe in words?</h2>
    ${sliderBlock({
      id: 'lk2',
      labels: ['The image was | completely | describable', 'The image was | mostly | describable', 'The image was | moderately | describable', 'The image was | mostly | undescribable', 'The image was | entirely | undescribable'],
      initial: 3
    })
    }
    <div class="row"><button id="next">Next</button></div>
  `);
  const slider = el('lk2');
  el('next').addEventListener('click', ()=>{
    Object.assign(S.data[S.data.length-1], { describable_1to5: slider.value });
    S.trial++;
    if (S.trial < N_TRIALS) fixation();
    else finish();
  });
}

function finish(){
  view(`
    <h2>Saving your responses…</h2>
    <p>Please wait a moment. Do not close this tab.</p>
  `);

  submitToServer(S.data)
    .then(() => {
      if (Recruit.source === 'prolific') {
        // send Prolific participants back to completion
        window.location.href = PROLIFIC.COMPLETION_URL;
      } else {
        // direct link users: show a thank-you + their generated ID
        view(`
          <h2>Thanks!</h2>
          <p>Your responses have been saved successfully.</p>
          <p class="help">Your participant ID is <span class="mono">${S.pid || Recruit.PROLIFIC_PID}</span>.</p>
        `);
      }
    })
    .catch(err => {
      // fallback UI if saving fails
      view(`
        <h2>We couldn’t save your responses automatically</h2>
        <p class="help">${String(err)}</p>
        <div class="row">
          <button id="retry">Try Again</button>
          <button id="download">Download CSV (backup)</button>
        </div>
        <p class="help">If this keeps failing, please contact us with your Participant ID: <span class="mono">${S.pid || Recruit.PROLIFIC_PID}</span>.</p>
      `);
      el('retry').addEventListener('click', ()=> finish());
      el('download').addEventListener('click', ()=> dlCSV(`image_descriptions_${S.pid||Recruit.PROLIFIC_PID}.csv`, S.data));
    });
}

/* =============== FLOW =============== */
function startTask(){
  // ALWAYS use the hard-coded IMAGES first. Fallback to picked files only if IMAGES is empty.
  let list = Array.isArray(IMAGES) && IMAGES.length ? IMAGES.slice() : [];

  if (!list.length && S.picked.length){
    list = S.picked
      .filter(f => /(\.jpe?g|\.png|\.gif|\.webp)$/i.test(f.name))
      .map(f => URL.createObjectURL(f));
  }

  if (list.length < N_TRIALS) {
    alert(`Need at least ${N_TRIALS} images. We currently see ${list.length}.
If using preloaded images, make sure the files exist at those paths and that the 'images/' folder is in the same directory as index.html (case-sensitive).`);
    return;
  }

  S.order = pick(list, N_TRIALS);
  S.trial = 0;

  // Preload and report any broken URLs to help debugging
  S.order.forEach(src=>{
    const im = new Image();
    im.onerror = ()=> console.warn("Image failed to load:", src);
    im.src = src;
  });

  fixation();
}

/* Kickoff */
start();
</script>
</body>
</html>
